define([],function(){function l(c,a,e,g,h){return{Login:function(a,b,f){c.post("/api/authenticate",{username:a,password:b}).success(function(b){f(b)})},SetCredentials:function(d,b){var f=q.encode(d+":"+b);e.globals={currentUser:{username:d,authdata:f}};c.defaults.headers.common.Authorization="Basic "+f;a.put("globals",e.globals)},ClearCredentials:function(){e.globals={};a.remove("globals");c.defaults.headers.common.Authorization="Basic"}}}function m(c,a,e){function g(b){var f=e.defer();b=a("filter")(h(),
{username:b});f.resolve(b.length?b[0]:null);return f.promise}function h(){localStorage.users||(localStorage.users=JSON.stringify([]));return JSON.parse(localStorage.users)}var d={GetAll:function(){var b=e.defer();b.resolve(h());return b.promise},GetById:function(b){var f=e.defer();b=a("filter")(h(),{id:b});f.resolve(b.length?b[0]:null);return f.promise}};d.GetByUsername=g;d.Create=function(b){var f=e.defer();c(function(){g(b.username).then(function(a){null!==a?f.resolve({success:!1,message:'Username "'+
b.username+'" is already taken'}):(a=h(),b.id=(a[a.length-1]||{id:0}).id+1,a.push(b),localStorage.users=JSON.stringify(a),f.resolve({success:!0}))})},1E3);return f.promise};d.Update=function(b){for(var a=e.defer(),c=h(),d=0;d<c.length;d++)if(c[d].id===b.id){c[d]=b;break}localStorage.users=JSON.stringify(c);a.resolve();return a.promise};d.Delete=function(a){for(var c=e.defer(),d=h(),g=0;g<d.length;g++)if(d[g].id===a){d.splice(g,1);break}localStorage.users=JSON.stringify(d);c.resolve();return c.promise};
return d}function n(c){(function(){c.$on("$locationChangeStart",function(){var a=c.flash;a&&(a.keepAfterLocationChange?a.keepAfterLocationChange=!1:delete c.flash)})})();return{Success:function(a,e){c.flash={message:a,type:"success",keepAfterLocationChange:e}},Error:function(a,e){c.flash={message:a,type:"error",keepAfterLocationChange:e}}}}var p=angular.module("bookApp.services",[]);l.$inject=["$http","$cookieStore","$rootScope","$timeout","UserService"];var q={keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\x3d",
encode:function(c){var a="",e,g,h="",d,b,f="",k=0;do e=c.charCodeAt(k++),g=c.charCodeAt(k++),h=c.charCodeAt(k++),d=e>>2,e=(e&3)<<4|g>>4,b=(g&15)<<2|h>>6,f=h&63,isNaN(g)?b=f=64:isNaN(h)&&(f=64),a=a+this.keyStr.charAt(d)+this.keyStr.charAt(e)+this.keyStr.charAt(b)+this.keyStr.charAt(f);while(k<c.length);return a},decode:function(c){var a="",e,g,h="",d,b="",f=0;/[^A-Za-z0-9\+\/\=]/g.exec(c)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '\x3d'\nExpect errors in decoding.");
c=c.replace(/[^A-Za-z0-9\+\/\=]/g,"");do e=this.keyStr.indexOf(c.charAt(f++)),g=this.keyStr.indexOf(c.charAt(f++)),d=this.keyStr.indexOf(c.charAt(f++)),b=this.keyStr.indexOf(c.charAt(f++)),e=e<<2|g>>4,g=(g&15)<<4|d>>2,h=(d&3)<<6|b,a+=String.fromCharCode(e),64!=d&&(a+=String.fromCharCode(g)),64!=b&&(a+=String.fromCharCode(h));while(f<c.length);return a}};m.$inject=["$timeout","$filter","$q"];n.$inject=["$rootScope"];p.factory("AuthenticationService",l).factory("UserService",m).factory("FlashService",
n);return p});